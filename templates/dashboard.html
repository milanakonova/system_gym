<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Личный кабинет</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body onload="loadDashboard()">
    <div class="container">
        <div class="dashboard">
            <div class="sidebar">
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <h3 id="userName">Загрузка...</h3>
                    <p id="userRole"></p>
                </div>
                
                <div class="nav-menu">
                    <div class="nav-item active" onclick="showSection('profile')">
                        <i class="fas fa-user"></i> Профиль
                    </div>
                    <div class="nav-item" onclick="showSection('schedule')">
                        <i class="fas fa-calendar-alt"></i> Расписание
                    </div>
                    <div class="nav-item" onclick="showSection('subscriptions')">
                        <i class="fas fa-id-card"></i> Абонементы
                    </div>
                    <div class="nav-item" onclick="showSection('visits')">
                        <i class="fas fa-history"></i> История посещений
                    </div>
                    <div class="nav-item" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Выйти
                    </div>
                </div>
            </div>
            
            <div class="dashboard-content">
                <div id="profileSection" class="section active">
                    <h2>Мой профиль</h2>
                    <div id="profileContent">
                        <p>Загрузка данных профиля...</p>
                    </div>
                </div>
                
                <div id="scheduleSection" class="section">
                    <h2>Расписание занятий</h2>
                    <div class="schedule-controls">
                        <button onclick="loadSchedule()" class="btn btn-primary">
                            <i class="fas fa-sync"></i> Обновить
                        </button>
                        <input type="date" id="scheduleDate" onchange="loadSchedule()">
                        <select id="scheduleLocation" onchange="loadSchedule()">
                            <option value="">Все залы</option>
                            <option value="gym">Тренажерный зал</option>
                            <option value="pool">Бассейн</option>
                            <option value="group_room">Групповые занятия</option>
                        </select>
                    </div>
                    <div id="scheduleContent">
                        <div class="schedule-grid" id="scheduleGrid">
                            <p>Загрузка расписания...</p>
                        </div>
                    </div>
                </div>
                
                <div id="subscriptionsSection" class="section">
                    <h2>Мои абонементы</h2>
                    <div id="subscriptionsContent">
                        <div class="subscription-card">
                            <h3>Основной абонемент</h3>
                            <p>Осталось посещений: <span id="visitsLeft">0</span></p>
                            <p>Статус: <span id="hasSubscription">Неактивен</span></p>
                            <button class="btn btn-primary" onclick="checkIn()">
                                <i class="fas fa-sign-in-alt"></i> Отметить посещение
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="visitsSection" class="section">
                    <h2>История посещений</h2>
                    <div id="visitsContent">
                        <p>Загрузка истории...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/static/js/app.js"></script>
    <script>
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById(sectionId + 'Section').classList.add('active');
            event.target.closest('.nav-item').classList.add('active');
        }
        
        async function checkIn() {
            const token = localStorage.getItem('access_token');
            try {
                const response = await fetch('/api/clients/me/check-in', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    document.getElementById('visitsLeft').textContent = result.visits_left;
                } else {
                    const error = await response.json();
                    alert(`Ошибка: ${error.detail}`);
                }
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Ошибка при отметке посещения');
            }
        }
        
        async function loadUserProfile(user) {
            const profileContent = document.getElementById('profileContent');
            profileContent.innerHTML = `
                <div class="profile-info">
                    <p><strong>Логин:</strong> ${user.username}</p>
                    <p><strong>Email:</strong> ${user.email}</p>
                    <p><strong>ФИО:</strong> ${user.full_name || 'Не указано'}</p>
                    <p><strong>Телефон:</strong> ${user.phone || 'Не указан'}</p>
                    <p><strong>Роль:</strong> ${user.role}</p>
                    <p><strong>Статус:</strong> ${user.is_active ? 'Активен' : 'Неактивен'}</p>
                </div>
            `;
        }
        
        async function loadDashboard() {
            const user = await getCurrentUser();
            if (!user) return;
            
            document.getElementById('userName').textContent = user.full_name || user.username;
            document.getElementById('userRole').textContent = user.role;
            
            await loadUserProfile(user);
            
            if (user.role === 'client') {
                await loadClientDashboard(user);
                await loadMyVisits();
                await loadSchedule();
            } else if (user.role === 'trainer') {
                await loadTrainerSchedule(user);
            }
        }
        
        async function loadMyVisits() {
            const token = localStorage.getItem('access_token');
            try {
                const response = await fetch('/api/attendance/me/history', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayVisits(data.history);
                }
            } catch (error) {
                console.error('Ошибка при загрузке истории:', error);
            }
        }
        
        function displayVisits(visits) {
            const visitsContent = document.getElementById('visitsContent');
            if (!visitsContent) return;
            
            if (visits.length === 0) {
                visitsContent.innerHTML = '<p>История посещений пуста</p>';
                return;
            }
            
            let html = '';
            visits.forEach(visit => {
                const checkIn = new Date(visit.check_in_time);
                const checkOut = visit.check_out_time ? new Date(visit.check_out_time) : null;
                
                html += `
                <div class="visit-card">
                    <p class="visit-time">
                        ${checkIn.toLocaleDateString()} ${checkIn.toLocaleTimeString()}
                        <span class="visit-method ${visit.method}">${visit.method}</span>
                    </p>
                    <p>Вход: ${checkIn.toLocaleTimeString()}</p>
                    ${checkOut ? `<p>Выход: ${checkOut.toLocaleTimeString()}</p>` : '<p>Выход: еще внутри</p>'}
                </div>
                `;
            });
            
            visitsContent.innerHTML = html;
        }
        
        async function loadSchedule() {
            const token = localStorage.getItem('access_token');
            if (!token) return;
            
            const dateInput = document.getElementById('scheduleDate');
            const locationSelect = document.getElementById('scheduleLocation');
            
            let url = '/api/schedule/';
            const params = new URLSearchParams();
            
            if (dateInput && dateInput.value) {
                params.append('date', dateInput.value);
            }
            
            if (locationSelect && locationSelect.value) {
                params.append('location', locationSelect.value);
            }
            
            if (params.toString()) {
                url += `?${params.toString()}`;
            }
            
            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const workouts = await response.json();
                    displaySchedule(workouts);
                }
            } catch (error) {
                console.error('Ошибка при загрузке расписания:', error);
            }
        }
        
        function displaySchedule(workouts) {
            const scheduleGrid = document.getElementById('scheduleGrid');
            if (!scheduleGrid) return;
            
            if (workouts.length === 0) {
                scheduleGrid.innerHTML = '<p class="no-data">На выбранную дату занятий нет</p>';
                return;
            }
            
            let html = '';
            
            workouts.forEach(workout => {
                const startTime = new Date(workout.start_time);
                const endTime = new Date(startTime.getTime() + workout.duration * 60000);
                
                const timeStr = `${startTime.getHours().toString().padStart(2, '0')}:${startTime.getMinutes().toString().padStart(2, '0')} - ${endTime.getHours().toString().padStart(2, '0')}:${endTime.getMinutes().toString().padStart(2, '0')}`;
                
                const locationNames = {
                    'gym': 'Тренажерный зал',
                    'pool': 'Бассейн',
                    'group_room': 'Групповые занятия',
                    'yoga_room': 'Йога-зал'
                };
                
                const typeNames = {
                    'personal': 'Индивидуальная',
                    'group': 'Групповая',
                    'open_gym': 'Открытый зал',
                    'swimming': 'Плавание'
                };
                
                html += `
                <div class="workout-card">
                    <div class="workout-header">
                        <h3>${typeNames[workout.workout_type] || workout.workout_type}</h3>
                        <span class="workout-time">${timeStr}</span>
                    </div>
                    <div class="workout-info">
                        <p><i class="fas fa-map-marker-alt"></i> ${locationNames[workout.location] || workout.location}</p>
                        <p><i class="fas fa-user"></i> Тренер: ID ${workout.trainer_id}</p>
                        <p><i class="fas fa-users"></i> ${workout.current_participants}/${workout.max_participants} мест</p>
                        ${workout.description ? `<p><i class="fas fa-info-circle"></i> ${workout.description}</p>` : ''}
                    </div>
                    <div class="workout-actions">
                        <button onclick="bookWorkout(${workout.id})" class="btn btn-primary btn-sm">
                            <i class="fas fa-calendar-plus"></i> Записаться
                        </button>
                    </div>
                </div>
                `;
            });
            
            scheduleGrid.innerHTML = html;
        }
        
        async function bookWorkout(workoutId) {
            const token = localStorage.getItem('access_token');
            if (!token) return;
            
            const user = await getCurrentUser();
            if (!user || user.role !== 'client') {
                alert('Только клиенты могут записываться на занятия');
                return;
            }
            
            if (!confirm('Вы уверены, что хотите записаться на это занятие?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/schedule/${workoutId}/book`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        client_id: user.id
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('Вы успешно записались на занятие!');
                    loadSchedule();
                } else {
                    const error = await response.json();
                    alert(`Ошибка: ${error.detail}`);
                }
            } catch (error) {
                console.error('Ошибка при записи:', error);
                alert('Ошибка при записи на занятие');
            }
        }
        
        async function loadTrainerSchedule(user) {
            const token = localStorage.getItem('access_token');
            try {
                const response = await fetch(`/api/schedule/trainer/${user.id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const workouts = await response.json();
                    displayTrainerSchedule(workouts);
                }
            } catch (error) {
                console.error('Ошибка при загрузке расписания тренера:', error);
            }
        }
        
        function displayTrainerSchedule(workouts) {
            const scheduleContent = document.getElementById('scheduleContent');
            if (!scheduleContent) return;
            
            if (workouts.length === 0) {
                scheduleContent.innerHTML = '<p>У вас нет запланированных занятий</p>';
                return;
            }
            
            let html = '<div class="trainer-schedule">';
            workouts.forEach(workout => {
                const startTime = new Date(workout.start_time);
                html += `
                <div class="trainer-workout">
                    <h4>${workout.workout_type} - ${workout.location}</h4>
                    <p>Время: ${startTime.toLocaleString()}</p>
                    <p>Длительность: ${workout.duration} минут</p>
                    <p>Участников: ${workout.current_participants}/${workout.max_participants}</p>
                </div>
                `;
            });
            html += '</div>';
            scheduleContent.innerHTML = html;
        }
    </script>
</body>
</html>
